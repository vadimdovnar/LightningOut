<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lightning Out 2.0 Test</title>
</head>
<body>
  <h3>Lightning Out 2.0 test</h3>

  <button id="resetBtn">Reset (clear PKCE)</button>

  <script
    id="lo2script"
    type="text/javascript"
    src="https://snoonu--dv.sandbox.my.salesforce.com/lightning/lightning.out.latest/index.iife.prod.js"
  ></script>

  <lightning-out-application
    id="loApp"
    app-id="1UsO20000000Bl3KAE"
    components="c-content-request-main"
  ></lightning-out-application>

  <c-content-request-main></c-content-request-main>

  <pre id="log"></pre>

  <script>
    const MY_DOMAIN = "https://snoonu--dv.sandbox.my.salesforce.com";
    const CLIENT_ID = "3MVG9RfdU0uTjsG2USrtpu3HuGQOJLSl1yUJmMPK4v84KeHVpedjc0nLlSDEQBAA7fuikBz8IZz2EmS3zgI6X";
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPE = "web";

    const logEl = document.getElementById("log");
    const log = (...args) => { logEl.textContent += args.join(" ") + "\n"; };

    // Storage keys
    const K_VERIFIER  = "lo2_pkce_verifier";
    const K_CHALLENGE = "lo2_pkce_challenge";
    const K_STATE     = "lo2_oauth_state";

    document.getElementById("resetBtn").onclick = () => {
      localStorage.removeItem(K_VERIFIER);
      localStorage.removeItem(K_CHALLENGE);
      localStorage.removeItem(K_STATE);
      log("Reset done ✅ Now refresh the page.");
    };

    function getQueryParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function stripQueryParams() {
      window.history.replaceState({}, document.title, REDIRECT_URI);
    }

    function randomString(len = 64) {
      const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~";
      let out = "";
      const bytes = new Uint8Array(len);
      crypto.getRandomValues(bytes);
      for (let i = 0; i < len; i++) out += charset[bytes[i] % charset.length];
      return out;
    }

    function base64UrlEncodeFromBytes(bytes) {
      let str = "";
      for (const b of bytes) str += String.fromCharCode(b);
      return btoa(str).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/, "");
    }

    async function pkceChallengeFromVerifier(verifier) {
      const enc = new TextEncoder().encode(verifier);
      const hash = await crypto.subtle.digest("SHA-256", enc);
      return base64UrlEncodeFromBytes(new Uint8Array(hash));
    }

    async function startOAuthPkce() {
      // If we already generated a verifier and state, REUSE them (prevents overwriting).
      let verifier = localStorage.getItem(K_VERIFIER);
      let state = localStorage.getItem(K_STATE);
      let challenge = localStorage.getItem(K_CHALLENGE);

      if (!verifier || !state || !challenge) {
        verifier = randomString(96);          // a bit longer, still valid (43-128)
        state = randomString(24);
        challenge = await pkceChallengeFromVerifier(verifier);

        localStorage.setItem(K_VERIFIER, verifier);
        localStorage.setItem(K_STATE, state);
        localStorage.setItem(K_CHALLENGE, challenge);
      }

      log("PKCE verifier length:", verifier.length);
      log("PKCE challenge (saved):", challenge);

      const authUrl = new URL(MY_DOMAIN + "/services/oauth2/authorize");
      authUrl.searchParams.set("response_type", "code");
      authUrl.searchParams.set("client_id", CLIENT_ID);
      authUrl.searchParams.set("redirect_uri", REDIRECT_URI);
      authUrl.searchParams.set("scope", SCOPE);
      authUrl.searchParams.set("code_challenge", challenge);
      authUrl.searchParams.set("code_challenge_method", "S256");
      authUrl.searchParams.set("state", state);

      log("Redirecting to OAuth authorize...");
      window.location.href = authUrl.toString();
    }

    async function exchangeCodeForToken(code) {
      const verifier = localStorage.getItem(K_VERIFIER);
      const expectedChallenge = localStorage.getItem(K_CHALLENGE);

      if (!verifier || !expectedChallenge) {
        throw new Error("Missing PKCE verifier/challenge in localStorage. Click Reset and retry.");
      }

      // Debug: recompute challenge and compare to stored one (detects overwrites)
      const recomputed = await pkceChallengeFromVerifier(verifier);
      log("PKCE challenge (recomputed):", recomputed);
      if (recomputed !== expectedChallenge) {
        throw new Error("PKCE mismatch locally (verifier was overwritten). Click Reset and retry.");
      }

      const body = new URLSearchParams();
      body.set("grant_type", "authorization_code");
      body.set("client_id", CLIENT_ID);
      body.set("redirect_uri", REDIRECT_URI);
      body.set("code", code);
      body.set("code_verifier", verifier);

      const resp = await fetch(MY_DOMAIN + "/services/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
      });

      if (!resp.ok) {
        const t = await resp.text();
        throw new Error("Token exchange failed: " + resp.status + " " + t);
      }

      return resp.json();
    }

    (async () => {
      try {
        const err = getQueryParam("error");
        const errDesc = getQueryParam("error_description");
        if (err) throw new Error(`OAuth error: ${err} ${errDesc || ""}`);

        const code = getQueryParam("code");
        const returnedState = getQueryParam("state");

        if (!code) {
          await startOAuthPkce();
          return;
        }

        const expectedState = localStorage.getItem(K_STATE);
        if (expectedState && returnedState && expectedState !== returnedState) {
          throw new Error("OAuth state mismatch. Click Reset and retry.");
        }

        log("Got OAuth code, exchanging for token...");
        const token = await exchangeCodeForToken(code);
        log("Got access token ✅");

        // clean URL
        stripQueryParams();

        log("Next step: singleaccess (we’ll handle after token is stable).");
      } catch (e) {
        log("ERROR:", e.message || e);
        console.error(e);
      }
    })();
  </script>
</body>
</html>
